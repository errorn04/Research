#include <stdio.h>
#include <time.h>
#include <stdlib.h>
#include <unistd.h> // For fork
#include <sys/types.h> // For pid_t (process ID)
#include <sys/wait.h> // For wait

void speed( char *path, char *program[] );
void usage( char *prog_name );

int main( int argc, char **argv ) {

	// Check command line args
	if( argc != 3 )	
		usage( argv[0] ); // Call usage since not enough cmd line args were inputted
		
	// Call speed and pass argv[1] as the parameter
	speed( argv[1], argv[2] );
	
}

void usage( char *prog_name ) {
	
	printf("[!] Usage: %s <path to program> <program to test the speed> \n", prog_name );
	exit(0);
	
}

void speed( char *path, char *program[] ) {
	
	// We need to spawn a child to run the program
	pid_t pid = fork();
	clock_t timer; // For the timer
	
	// Start the timer
	timer = clock();
	
	// Child process
	if( pid == 0 ) {
		
		// Execute the file
		execv( path, program );
		
		// Only if execv() fails and assuming shell is bash
		exit(127);
		
	} else { // pid != 0; parent process
		
		waitpid( pid, 0, 0 ); // Wait for child to exit
		
	}
	
	// End timer
	timer = clock() - timer;
	
	// Calculate the time taken
	double time_taken = ((double)timer) / CLOCKS_PER_SEC; // In seconds
	
	printf("[*] %s took %f seconds to execute \n", program, time_taken );
	
}
